{% extends "base.html" %}
{% block title %}Detail rezervace{% endblock %}

{% block content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Detail rezervace</h3>
    <div class="text-secondary small">{{ r.resource.name }} · {{ r.start.strftime("%Y-%m-%d %H:%M") }} → {{ r.end.strftime("%H:%M") }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('calendar_view') }}">Zpět</a>
    {% if current_user.role == 'admin' %}
      <a class="btn btn-primary" href="{{ url_for('edit', rid=r.id) }}">Upravit</a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="mb-2">{{ r.title }}</h4>

        <div class="text-secondary small mb-2">
          Stav: <b>{{ r.status }}</b>
        </div>

        <div class="row g-2 small">
          {% if r.client %}<div class="col-12"><b>Zákazník:</b> {{ r.client }}</div>{% endif %}
          {% if r.contact %}<div class="col-12"><b>Kontakt:</b> {{ r.contact }}</div>{% endif %}
          {% if r.location %}<div class="col-12"><b>Místo:</b> {{ r.location }}</div>{% endif %}
          {% if r.guests is not none %}<div class="col-12"><b>Hosté:</b> {{ r.guests }}</div>{% endif %}
          {% if r.note %}<div class="col-12"><b>Poznámka:</b><br>{{ r.note }}</div>{% endif %}
        </div>

        {% if current_user.role == 'admin' %}
          <hr>
          <div class="d-flex gap-2 flex-wrap">
            <form method="post" action="{{ url_for('cancel', rid=r.id) }}" class="m-0">
              <button class="btn btn-outline-warning btn-sm" type="submit">Zrušit (cancelled)</button>
            </form>
            <form method="post" action="{{ url_for('delete', rid=r.id) }}" class="m-0"
                  onsubmit="return confirm('Opravdu smazat rezervaci?');">
              <button class="btn btn-outline-danger btn-sm" type="submit">Smazat</button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">Brigádníci na akci</h5>

        {% if current_user.role == 'admin' %}
          <form method="post" action="{{ url_for('admin_add_signup', rid=r.id) }}" class="d-flex gap-2 flex-wrap mb-3">
            <select class="form-select form-select-sm" name="user_id" required style="max-width:260px">
              <option value="">+ Přidat brigádníka…</option>
              {% set signed_ids = r.signups | map(attribute='user_id') | list %}
              {% for u in users %}
                {% if u.id not in signed_ids %}
                  <option value="{{ u.id }}">{{ u.username }}{% if u.full_name %} — {{ u.full_name }}{% endif %}</option>
                {% endif %}
              {% endfor %}
            </select>
            <button class="btn btn-outline-primary btn-sm" type="submit">Přidat</button>
          </form>
        {% else %}
          <form method="post" action="{{ url_for('signup_to_reservation', rid=r.id) }}" class="mb-3">
            <button class="btn btn-outline-primary btn-sm" type="submit">Přihlásit se na akci</button>
          </form>
        {% endif %}

        {% if r.signups %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Uživatel</th>
                  <th class="text-end">Min</th>
                  <th class="text-end">Hod</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for s in r.signups %}
                <tr>
                  <td>
                    <b>{{ s.user.username }}</b>
                    <div class="text-secondary small">{{ s.user.full_name or '' }}</div>
                  </td>

                  {% if current_user.role == 'admin' %}
                    <td colspan="2">
                      <form method="post" action="{{ url_for('admin_set_hours', rid=r.id, sid=s.id) }}" class="d-flex gap-2">
                        <input class="form-control form-control-sm" style="max-width:110px" name="minutes" value="{{ s.minutes or 0 }}" type="number" min="0" step="5">
                        <input class="form-control form-control-sm" name="note" value="{{ s.note or '' }}" placeholder="poznámka (vol.)">
                        <button class="btn btn-outline-primary btn-sm" type="submit">Uložit</button>
                      </form>
                    </td>
                    <td class="text-end">
                      <form method="post" action="{{ url_for('admin_remove_signup', rid=r.id, sid=s.id) }}" class="m-0">
                        <button class="btn btn-outline-danger btn-sm" type="submit">Odebrat</button>
                      </form>
                    </td>
                  {% else %}
                    <td class="text-end">{{ s.minutes }}</td>
                    <td class="text-end">{{ (s.minutes/60)|round(2) }}</td>
                    <td></td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-secondary">Zatím nikdo není přihlášen.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
